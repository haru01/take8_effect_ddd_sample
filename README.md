# 履修管理システム実装計画 - E2Eファーストアプローチ

## 概要
E2Eテストから始めるストーリー単位の実装により、ユーザー価値を段階的に提供します。
各ストーリー完了時点で動作するソフトウェアが存在し、早期フィードバックが可能です。

**現在のステータス**: ストーリー1完了 ✅ → ストーリー2開始準備 🎯

## 実装方針
1. **E2Eテストファースト**: 失敗するテストから開始
2. **ストーリー単位**: バーティカルスライスで価値を提供
3. **最小限実装**: テストが通る最小限のコード
4. **段階的拡張**: 前ストーリー完了後に次へ進む
5. CQRS、ビジネスイベントの記録と、現状の状態参照は分離する

## ユーザーストーリー実装順序

### ✅ 完了済み
- [x] プロジェクト基盤構築（境界づけられたコンテキスト構成）
- [x] ドメイン層基本実装（集約、エンティティ、値オブジェクト）
- [x] ドメインモデルテスト（25テスト）
- [x] **ストーリー1: 履修登録セッション開始** - 包括的なE2Eテスト + カスタムアサーション実装

### ✅ ストーリー1: 履修登録セッション開始 (完了)
**AS A** 学生
**I WANT TO** 履修科目を選択するために履修登録セッションを開始する
**SO THAT** 履修登録プロセスを始められる

**実装タスク**:
- [x] E2Eテスト: セッション作成の成功シナリオ
- [x] E2Eテスト: 重複セッション作成の失敗シナリオ
- [x] E2Eテスト: バリデーションエラーケース
- [x] E2Eテスト: 複数セッション作成テスト
- [x] ドメインイベント: `RegistrationSessionCreated`
- [x] ドメインエラー: `SessionAlreadyExists`
- [x] アプリケーションコマンド: `CreateRegistrationSessionCommand`
- [x] インメモリEventStore実装
- [x] インメoryEventBus実装
- [x] インメモリRepository実装
- [x] カスタムテストアサーション実装
- [x] テスト通過確認（6テスト全パス）

**受け入れ条件**:
- [x] 学生IDと学期を指定してセッションを作成できる
- [x] 同じ学生・学期の重複セッション作成は失敗する
- [x] 作成されたセッションはDraft状態である
- [x] セッションIDが生成され、後の操作で使用できる
- [x] リポジトリからセッションを取得可能
- [x] イベントバスにイベントが正しく発行される
- [x] バリデーションエラーが適切にハンドリングされる

**実装成果**:
- 真のE2Eテスト: コマンド→ドメイン→イベントストア→イベントバス→リポジトリ→クエリ
- カスタムアサーション: 再利用可能で読みやすいテストヘルパー
- Effect-TSによる型安全な実装
- イベントソーシングパターンの完全実装

### 🎯 ストーリー2: 科目一括追加 (次のターゲット)
**AS A** 学生
**I WANT TO** 選択した複数の科目を履修登録セッションに一括で追加する
**SO THAT** 効率的に履修科目を登録できる

**既存実装済み要素**:
- [x] ドメインモデル基盤 (`RegistrationSession` クラス)
- [x] 重複チェックロジック (`hasCourse`, `findDuplicateCourses`)
- [x] ビジネスルール定数 (`MAX_UNITS_PER_TERM = 20`)
- [x] 状態チェック (`canModifyCourses`)
- [x] 基盤インフラ (EventStore, EventBus, Repository)

**実装タスク** (TDDアプローチで効率的実装):
- [ ] E2Eテストファイル作成 (`tests/stories/course-addition.e2e.test.ts`)
  - [ ] 科目一括追加の成功シナリオ
  - [ ] 単位数上限超過の失敗シナリオ  
  - [ ] 重複科目追加の失敗シナリオ
  - [ ] セッション未存在での追加失敗シナリオ
  - [ ] 不正状態(Draft以外)での追加失敗シナリオ
- [ ] ドメインエラー実装 (`MaxUnitsExceeded`, `DuplicateCourseInSession`, `InvalidSessionState`)
- [ ] ドメインイベント実装 (`CoursesAddedToSession`, `EnrollmentsRequestedBatch`)
- [ ] ドメインロジック統合 (`addCourses` メソッド追加)
- [ ] アプリケーションコマンド実装 (`AddCoursesToSessionCommand`)
- [ ] カスタムアサーション拡張（科目追加用テストヘルパー）
- [ ] 統合テストと動作確認

**実装方針**:
- **既存インフラ活用**: EventStore, EventBus, Repository流用で効率化
- **CLAUDE.md準拠**: 一括操作アーキテクチャに基づく実装
- **Effect-TS活用**: 型安全な副作用管理と実行時バリデーション

**受け入れ条件**:
- 複数科目を一度に追加できる
- 重複科目の追加は失敗する（既存ロジック活用）
- 単位数上限（20単位）を超える追加は失敗する
- 追加後のセッションに科目と単位数が反映される
- Draft状態でのみ科目追加が可能
- 適切なドメインイベントが発行される

**期待成果**:
- E2Eテスト: 6 → 11 (+5テスト)
- カバレッジ維持: 90%以上  
- 型安全性: TypeScriptエラー0
- 次ストーリー（履修登録提出）への基盤構築完了

### 📝 ストーリー3: 履修登録提出
**AS A** 学生
**I WANT TO** 選択した科目を確定するために履修登録を提出する
**SO THAT** アドバイザーによる承認を受けられる

**実装タスク**:
- [ ] E2Eテスト: 履修登録提出の成功シナリオ
- [ ] E2Eテスト: 最小単位数不足の失敗シナリオ
- [ ] E2Eテスト: 不正状態での提出失敗シナリオ
- [ ] ドメインイベント: `RegistrationSessionSubmitted`
- [ ] ドメインエラー: `MinUnitsNotMet`, `InvalidSessionState`
- [ ] ドメインロジック: セッション提出、最小単位数チェック
- [ ] アプリケーションコマンド: `SubmitRegistrationSessionCommand`
- [ ] テスト通過確認

**受け入れ条件**:
- Draft状態のセッションを提出できる
- 最小単位数（12単位）未満の場合は失敗する
- 提出後はSubmitted状態になる
- Draft以外の状態では提出できない

### ✅ ストーリー4: アドバイザー承認
**AS AN** アドバイザー
**I WANT TO** 提出された履修登録を確認して承認・却下する
**SO THAT** 学生の履修計画が適切であることを保証できる

**実装タスク**:
- [ ] E2Eテスト: 履修登録承認の成功シナリオ
- [ ] E2Eテスト: 履修登録却下の成功シナリオ
- [ ] E2Eテスト: 承認待ち一覧取得
- [ ] ドメインイベント: `RegistrationSessionApproved/Rejected`, `EnrollmentsApprovedBatch`
- [ ] ドメインロジック: セッション承認/却下
- [ ] アプリケーションコマンド: `ApproveRegistrationSessionCommand`, `RejectRegistrationSessionCommand`
- [ ] アプリケーションクエリ: `GetPendingSessionsQuery`
- [ ] テスト通過確認

**受け入れ条件**:
- Submitted状態のセッションを承認できる
- 承認理由と承認者を記録する
- 承認後はApproved状態になり、関連履修もApproved状態になる
- 却下時は理由と却下者を記録する
- 承認待ちセッション一覧を取得できる

### 🚀 ストーリー5: 履修開始
**AS A** 学生
**I WANT TO** 承認された履修について学期開始時に履修を開始する
**SO THAT** 授業に参加して単位取得に向けて学習できる

**実装タスク**:
- [ ] E2Eテスト: 履修開始の成功シナリオ
- [ ] E2Eテスト: 一括履修開始（学期開始処理）
- [ ] ドメインイベント: `EnrollmentStarted`
- [ ] ドメインロジック: 履修開始
- [ ] アプリケーションコマンド: `StartEnrollmentCommand`, `StartTermEnrollmentsCommand`
- [ ] テスト通過確認

**受け入れ条件**:
- Approved状態の履修を開始できる
- 履修開始後はInProgress状態になる
- 学期開始時に該当する全履修を一括開始できる
- 開始日時が記録される

## E2Eテスト戦略

### テストカテゴリ
- **😊 ハッピーパス**: 正常な業務フロー
- **😱 エラーケース**: 異常系・境界値
- **🔄 状態遷移**: 不正な状態変更の防止
- **🏢 ビジネスルール**: ドメイン制約の検証

### テスト環境
- インメモリ実装によるfast feedback
- 実際のAPIインターフェースでの統合テスト
- Given-When-Then形式による明確な仕様記述

### テストファイル構成
```
tests/
├── helpers/
│   └── assertions.ts                               # カスタムテストアサーション
└── stories/
    ├── registration-session-start.e2e.test.ts     # ✅ ストーリー1 (完了)
    ├── course-addition.e2e.test.ts                 # 🎯 ストーリー2 (次)
    ├── session-submission.e2e.test.ts              # 📝 ストーリー3
    ├── advisor-approval.e2e.test.ts                # ✅ ストーリー4
    └── enrollment-start.e2e.test.ts                # 🚀 ストーリー5
```

## 実装完了の定義
各ストーリーで以下が完了すること：
1. ✅ すべてのE2Eテストがパス
2. 🏗️ 必要な実装が完了（Domain→Application→Infrastructure）
3. 📊 型チェックとLintエラーなし
4. 📖 テストが仕様書として機能
5. 🔄 前ストーリーとの統合動作確認

## 開発フロー
```
1. E2Eテスト作成（失敗する）
2. 必要なインターフェースを特定
3. ドメイン層実装
4. アプリケーション層実装
5. インフラ層実装（インメモリ）
6. テスト通過確認
7. リファクタリング
8. 次ストーリーへ
```

## 次期実装候補（バックログ）
- 科目置換機能（ストーリー2の拡張）
- 履修完了・成績付与
- 履修離脱処理
- PostgreSQL永続化
- Read Model投影
- REST API実装
- ユーザーインターフェース

## 技術スタック
- **言語**: TypeScript
- **フレームワーク**: Effect-TS
- **アーキテクチャ**: DDD + CQRS + Event Sourcing
- **テスト**: Vitest (E2E, Unit)
- **データベース**: インメモリ → PostgreSQL
- **CI/CD**: GitHub Actions (予定)